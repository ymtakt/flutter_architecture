# エラーハンドリング

## external

- Result 型を return する
- HttpClient など 外部サービス固有の情報が必要な場合は専用の Result 型を定義して（例：HttpResponse 型） return する
- external な 3rd party sdk で起きたエラーの理由がわかる情報を失敗 Result 含める（例：Object e, Http status code）
- 3rd party sdk で取り扱っているすべてのエラー種別を網羅すべき必要はない

## service

-

## entity

- クライアントアプリが取り扱いたいエラーの概念

```dart
/// Todoの追加の際にタイトルがない場合スローされる例外。
class AddTodoMissingTitleException implements Exception {}

/// Todoの追加に失敗した際にスローされる例外。
class AddTodoException implements Exception {}
```

## repository

- return する値はクライアントアプリが取り扱いたいエラーの概念（Entity）や Exception = 3rd party sdk の情報を含めるべきでない

```dart
class TodoRepository {
  /** 省略 */
  Future</** 省略 */> addTodo(/** 省略 */) async {
    try{}..
    /** 省略 */
    throw AddTodoMissingTitleException();

    /** 省略 */
    throw AddTodoException();
  }
}
```

## logic/useCase

## viewModel,logic/Notifier

## handler

- repository 層 または logic/useCase 層で スローされた Exception 型から UI に適したエラー状態に変換する
- viewModel 層の場合は viewModel のエラー状態を参照する
- 一時的な UI 制御（SnackBar、Dialog 等）を行う際に利用する

```dart
class TodosPageHandler {
  /** 省略 */
  Future</** 省略 */> addTodo(/** 省略 */) async {
    /** 省略 */
    try {
        _ref.read(todoRepositoryProvider).addTodo(/** 省略 */);
    } catch (e) {
        if (e is AddTodoException) {
            showDialog(/** 省略 */);
        }
         showDialog(/** 省略 */);
    }
  }
}
```

## page

- スローされた Exception 型から UI に適したエラー状態に変換する
- エラーウィジェットを表示する

```dart
/** 省略 */
ref.watch(todosPageViewModelProvider).when(
    /** 省略 */
    error: (e) {
        if (e is FetchTodosException) {
            return Text("Todo一覧の取得に失敗しました");
        }
        return Text("画面表示に失敗しました");
    }
)
```

### ログの方針

- external 層で外界のエラーログを送る
- repository 層でドメインレベルのエラーを送る

```mermaid

graph TD
    %% External Layer
    EXT[External Layer<br/>外部SDK呼び出し]
    EXT_SUCCESS[HttpResponse&lt;Data&gt;<br/>Result&lt;User, AuthError&gt;]
    EXT_LOG[Logger<br/>外界エラーログ]
    EXT_EXCEPTION[設定エラー<br/>Exception Throw]

    %% Service Layer
    SVC[Service Layer<br/>DTO処理]
    SVC_RESULT[同じResult型を維持<br/>HttpResponse&lt;UserDto&gt;]

    %% Repository Layer
    REPO[Repository Layer<br/>Entity変換]
    REPO_RESULT[同じResult型を維持<br/>Result&lt;User, UserError&gt;]
    REPO_LOG[Logger<br/>ドメインレベルログ]

    %% Logic/UseCase Layer
    LOGIC[Logic/UseCase Layer<br/>複数データ統合]
    LOGIC_RESULT[同じResult型を維持<br/>Result&lt;Dashboard, DashboardError&gt;]

    %% UI Layers
    VM[ViewModel/Notifier<br/>画面状態管理]
    VM_STATE[PageState<br/>errorMessage: string<br/>isLoading: bool]

    HANDLER[Handler<br/>UI操作制御]
    HANDLER_UI[一時的UI制御<br/>SnackBar表示<br/>Dialog表示]

    PAGE[Page Widget<br/>画面描画]
    ERROR_WIDGET[Error Widget<br/>エラー画面表示]

    %% Flow connections
    EXT --> EXT_SUCCESS
    EXT_SUCCESS --> SVC
    SVC --> SVC_RESULT
    SVC_RESULT --> REPO
    REPO --> REPO_RESULT
    REPO_RESULT --> LOGIC
    LOGIC --> LOGIC_RESULT

    %% State transformation flows
    REPO_RESULT --> VM
    LOGIC_RESULT --> VM
    VM --> VM_STATE
    VM_STATE --> PAGE

    REPO_RESULT --> HANDLER
    LOGIC_RESULT --> HANDLER
    VM_STATE --> HANDLER
    HANDLER --> HANDLER_UI
    PAGE --> ERROR_WIDGET

    %% Logging flows
    EXT -.-> EXT_LOG
    REPO -.-> REPO_LOG

    %% Exception flow
    EXT --> EXT_EXCEPTION
    EXT_EXCEPTION --> APP_CRASH[App Crash<br/>起動時クラッシュ]

    %% Styling
    classDef layerBox fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef resultBox fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef stateBox fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef uiBox fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef logBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef exceptionBox fill:#ffebee,stroke:#d32f2f,stroke-width:2px

    class EXT,SVC,REPO,LOGIC layerBox
    class EXT_SUCCESS,SVC_RESULT,REPO_RESULT,LOGIC_RESULT resultBox
    class VM_STATE stateBox
    class VM,HANDLER,PAGE,ERROR_WIDGET,HANDLER_UI uiBox
    class EXT_LOG,REPO_LOG logBox
    class EXT_EXCEPTION,APP_CRASH exceptionBox

```
