## ディレクトリ構造

```
.
.
├── external
│   └── shared_preferences
│       ├── shared_preferences_client.dart
│       └── shared_preferences_client.g.dart
├── model
│   ├── entity
│   │   └── feature
│   │       ├── children.dart
│   │       ├── children.freezed.dart
│   │       └── user.dart
│   ├── logic
│   ├── repository
│   │   └── feature
│   │       └── account
│   │           ├── account_children.repository.dart
│   │           └── account_children.repository.g.dart
│   └── service
│       ├── feature
│       │   └── children
│       │       ├── children_dto.dart
│       │       ├── children_dto.freezed.dart
│       │       ├── children_dto.g.dart
│       │       ├── children_service.dart
│       │       └── children_service.g.dart
│       └── util
│           └── shared_preferences
│               └── shared_preferences_helper.dart
├── ui
│   ├── page
│   │   └── account
│   │       ├── account_child_detail_page
│   │       │   ├── account_child_detail_page_handler.dart
│   │       │   ├── account_child_detail_page_handler.g.dart
│   │       │   ├── account_child_detail_page_view_model.dart
│   │       │   ├── account_child_detail_page_view_model.freezed.dart
│   │       │   ├── account_child_detail_page_view_model.g.dart
│   │       │   └── account_child_detail_page.dart
│   │       ├── account_child_edit_page
│   │       │   ├── account_child_edit_page_handler.dart
│   │       │   ├── account_child_edit_page_handler.g.dart
│   │       │   ├── account_child_edit_page_view_model.dart
│   │       │   ├── account_child_edit_page_view_model.freezed.dart
│   │       │   ├── account_child_edit_page_view_model.g.dart
│   │       │   └── account_child_edit_page.dart
│   │       ├── account_child_register_page
│   │       │   ├── account_child_register_page_handler.dart
│   │       │   ├── account_child_register_page_handler.g.dart
│   │       │   └── account_child_register_page.dart
│   │       ├── account_page
│   │       │   ├── account_page_view_model.dart
│   │       │   ├── account_page_view_model.freezed.dart
│   │       │   ├── account_page_view_model.g.dart
│   │       │   └── account_page.dart
│   │       └── account_child_form.dart
│   ├── routing
│   │   ├── router_path.dart
│   │   └── router.dart
│   └── shared
│       ├── functional
│       └── functionless
│           ├── common_button.dart
│           ├── common_date_picker.dart
│           ├── common_select_box.dart
│           └── common_text_field.dart
├── util
└── main.dart
```

## external

- Flutter アプリにとっての外側の機能の呼び出しを担当する層
  - モデルにとっての外界の例：HttpClient, Firebase analytics の SDK などのモデルが利用する外界の機能
  - UI やモバイルアプリとしての振る舞いにとっての外界の例： DeepLink 関係の SDK など
- Flutter エントリーポイントでモバイルアプリの世界に入る入り口で使う場合などもある

## model

### service

- external 層との通信を行う層
- DTO を定義して返す
- この段階ではクライアントアプリの業務知識と必ずしも一致するわけではない

### entity

- クライアントアプリとして取り扱う業務知識のデータ（Entity）を定義する
- 業務知識の関心事ごとに分ける
- freezed で定義する

### repository

- service 層との通信を行い業務知識を作成する
- DTO から Entity への 変換
  例：サーバーサイドで定義されている 3 つの API エンドポイントをまとめて呼び 1 つの Entity を生み出す

- サーバーサイドで定義されている API エンドポイントの通信を行う際は、open api generator を使用しているため、
  service 層（DTO）ではなく ApiClient（APIModel）を使用する

### logic

- 業務知識・業務ロジックとして実現したいロジックを実装する（画面関係ない）

  - Notifier で Entity を取得、キャッシュ、操作する（グローバルな状態管理）
    - Repository 層との通信を行う
  - useCase クラスやトップレベルの関数：業務上必要な計算（例：BMI の計算、配列処理、状態管理を伴わないデータの読み書きメソッドの呼び出し）

- Notifier も viewModel より少なくなる
- このアプリは handler から 直接 Repository を読んで良いので UseCase はそこまで多くならない

## ui

### page

- 各画面の UI を実装する
- pageViewModel を ref.watch して画面の状態を監視する
- イベントハンドリングは全て pageHandler のメソッドを呼ぶことで実現する
- ConsumerWidget を使用して OK
- go router で管理する画面と一致する

#### pageViewModel

- ページの状態管理を行うための viewModel
- ページで表示する状態を保持して view と同期する

  - Notifier で実装する
  - freezed で定義した page に必要な状態全体を管理する
  - Page 全体で統合された唯一のローディング・エラー・データ (AsyncValue) を提供する

- repository 層または、logic 層との通信を行い状態の取得や更新に必要な処理を呼び出す
- ライフサイクルが Page と一致する

メモ：
BuildContext NG
UI のことは知らない（Flutter は出てこない）

#### pageHandler

- ページで行われる全てのイベントハンドリングを実装する
- Page からは典型的にはタップ、入力、スワイプなどの UI 操作をトリガーとして呼びだされる
- イベントハンドリング（=ユーザー操作）に伴って実行するべき viewModel,logic または repository 層の処理を呼び出す
  - その際発生する例外を キャッチして必要な場合はユーザーに適切にフィードバックする（例：alertDialog や snackBar を出す）

メモ：
BuildContext OK
UI のことを知っている

### shared

#### functional

- ページ単位ではないいわゆる部品だが、独立して通信や状態管理を行うべきウィジェット
  - アプリ内様々な画面から利用される
  - 例：ショッピングアプリのカートウィジェット（購入画面、商品一覧、アカウント詳細度複数の画面で使用される）
- xxxSection と命名する
- ウィジェットごとに、SectionWidget,SectionHandler,SectionViewModel が定義される

メモ：
WidgetRef OK

#### functionless

- view 以外の機能を持たない UI（Widget やスタイルガイドなど） を定義する
  - Typography や AppColor など Figma のスタイルガイド
  - Button や Dialog など Figma の基礎コンポーネントやそれらを組み合わせた AppBar や ListTile などのコンポーネント
- StatelessWidget または StatefulWidget だけで実装する
- 受け取った props を元に view を表示し、イベントハンドリングは受け取ったコールバックを呼び出すのみ

メモ：
WidgetRef NG
